<div class="panel panel-default">
  <div class="panel-heading">Related</div>
  <div class="panel-body">
    <ul>

      {% assign has_related = false %}
      {% assign numtags = page.tags | size %}
      {% for other in site.posts %}
        {% if other.url != page.url %}
          {% assign count = 0 %}
          {% for othertag in other.tags %}
            {% if page.tags contains othertag %}
              {% assign count = count | plus: 1 %}
            {% endif %}
          {% endfor %}
          {% if count > 2 || (count > 1 && count == numtags) %}
            {% assign has_related = true %}
            <li><a href="{{ other.url }}">{{other.title}}</a></li>
          {% endif %}
        {% endif %}
      {% endfor %}


      {% if has_related == false %}
        {% for post in site.related_posts %}
          <li><a href="{{ post.url }}">{{post.title}}</a></li>
        {% endfor %}
      {% endif %}

    </ul>
  </div>
</div>
